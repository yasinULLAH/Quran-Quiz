<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Surah Challenge - Yasin</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #16a085;
            --accent-color: #e74c3c;
            --bg-color: #f9f9f9;
            --text-color: #333;
            --highlight: #f1c40f;
            --card-bg: #fff;
            --shadow: rgba(0,0,0,0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            padding: 20px;
            background-image: linear-gradient(to right, rgba(240,240,240,0.5) 1px, transparent 1px),
                              linear-gradient(to bottom, rgba(240,240,240,0.5) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 15px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            box-shadow: 0 10px 30px var(--shadow);
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: repeating-linear-gradient(0deg, transparent, transparent 15px, rgba(255,255,255,0.05) 15px, rgba(255,255,255,0.05) 30px);
            z-index: 0;
        }
        
        .header h1 {
            position: relative;
            z-index: 1;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .header p {
            position: relative;
            z-index: 1;
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px var(--shadow);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px var(--shadow);
        }
        
        button {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            margin: 5px;
            box-shadow: 0 3px 6px var(--shadow);
        }
        
        button:hover {
            background: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 5px 12px var(--shadow);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-primary {
            background: var(--primary-color);
        }
        
        .btn-accent {
            background: var(--accent-color);
        }
        
        .btn-highlight {
            background: var(--highlight);
            color: var(--primary-color);
        }
        
        input, select {
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 1rem;
            width: 100%;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 2px rgba(22, 160, 133, 0.2);
        }
        
        .clue-container {
            background: #f5f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 5px solid var(--secondary-color);
        }
        
        .clue-text {
            font-size: 1.2rem;
            margin-bottom: 15px;
            line-height: 1.6;
        }
        
        .arabic-text {
            font-family: 'Traditional Arabic', 'Scheherazade', serif;
            font-size: 1.6rem;
            line-height: 2;
            text-align: right;
            margin: 15px 0;
            direction: rtl;
        }
        
        .options-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .option-btn {
            width: 100%;
            text-align: center;
            padding: 15px;
            background: #fff;
            border: 2px solid #ddd;
            border-radius: 10px;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .option-btn:hover {
            border-color: var(--secondary-color);
            background: #f8f8f8;
        }
        
        .correct {
            border-color: #2ecc71;
            background: rgba(46, 204, 113, 0.1);
        }
        
        .incorrect {
            border-color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
        }
        
        .progress-container {
            height: 10px;
            background: #eee;
            border-radius: 5px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: var(--secondary-color);
            width: 0%;
            transition: width 0.5s;
        }
        
        .score-display {
            text-align: center;
            font-size: 1.2rem;
            margin: 20px 0;
        }
        
        .score-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--secondary-color);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: #fff;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
            margin: 5px 0;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #777;
        }
        
        .screen {
            display: none;
        }
        
        .active-screen {
            display: block;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .setting-card {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }
        
        .setting-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .separator {
            height: 1px;
            background: #eee;
            margin: 20px 0;
        }
        
        .dropdown {
            position: relative;
            display: inline-block;
        }
        
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            transition: all 0.2s;
        }
        
        .dropdown-content a:hover {
            background-color: #f1f1f1;
        }
        
        .show {
            display: block;
        }
        
        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px 0;
            color: #777;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }
            
            .options-container {
                grid-template-columns: 1fr;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--secondary-color);
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .hint-badge {
            display: inline-block;
            padding: 3px 8px;
            background: var(--highlight);
            color: var(--primary-color);
            border-radius: 20px;
            font-size: 0.8rem;
            margin-right: 10px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 90%;
            width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
        }
        
        .close-modal {
            position: absolute;
            right: 20px;
            top: 15px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #777;
        }
    </style>
</head>
<body>
<div class="container">
<div class="header">
<h1>Surah Challenge</h1>
<p>Test your knowledge of the Holy Quran</p>
</div>

        <!-- Loading Screen -->
        <div id="loading-screen" class="screen active-screen">
            <div class="card">
                <h2>Loading Surah Challenge...</h2>
                <div class="loading-spinner"></div>
                <p id="loading-status">Initializing...</p>
            </div>
        </div>
        
        <!-- Welcome Screen -->
        <div id="welcome-screen" class="screen">
            <div class="card">
                <h2>Welcome to Surah Challenge</h2>
                <p>Test your knowledge of the Holy Quran through an interactive quiz game.</p>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="total-questions-completed">0</div>
                        <div class="stat-label">Questions Completed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-surahs-learned">0/114</div>
                        <div class="stat-label">Surahs Learned</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="highest-score">0</div>
                        <div class="stat-label">Highest Score</div>
                    </div>
                </div>
                <div class="separator"></div>
                <div style="text-align: center;">
                    <button id="start-game-btn" class="btn-primary">Start New Game</button>
                    <button id="learn-mode-btn">Learn Mode</button>
                    <button id="settings-btn">Settings</button>
                </div>
            </div>
        </div>
        
        <!-- Game Setup Screen -->
        <div id="game-setup-screen" class="screen">
            <div class="card">
                <h2>Game Setup</h2>
                <div class="settings-grid">
                    <div class="setting-card">
                        <div class="setting-title">Difficulty Level</div>
                        <select id="difficulty-select">
                            <option value="easy">Easy</option>
                            <option value="medium">Medium</option>
                            <option value="hard">Hard</option>
                        </select>
                    </div>
                    <div class="setting-card">
                        <div class="setting-title">Question Type</div>
                        <select id="question-type-select">
                            <option value="multiple-choice">Multiple Choice</option>
                            <option value="type-in">Type In Answer</option>
                        </select>
                    </div>
                    <div class="setting-card">
                        <div class="setting-title">Number of Questions</div>
                        <select id="question-count-select">
                            <option value="5">5 Questions</option>
                            <option value="10" selected>10 Questions</option>
                            <option value="20">20 Questions</option>
                            <option value="30">30 Questions</option>
                        </select>
                    </div>
                    <div class="setting-card">
                        <div class="setting-title">Focus Area</div>
                        <select id="focus-area-select">
                            <option value="all">All Surahs</option>
                            <option value="my-journey">My Quran Journey</option>
                            <option value="juz1-10">Juz 1-10</option>
                            <option value="juz11-20">Juz 11-20</option>
                            <option value="juz21-30">Juz 21-30</option>
                        </select>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button id="start-game-now-btn" class="btn-primary">Start Game</button>
                    <button id="back-to-main-btn">Back</button>
                </div>
            </div>
        </div>
        
        <!-- Game Screen -->
        <div id="game-screen" class="screen">
            <div class="card">
                <div class="progress-container">
                    <div id="progress-bar" class="progress-bar"></div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>Question <span id="current-question">1</span>/<span id="total-questions">10</span></div>
                    <div>Score: <span id="current-score">0</span></div>
                    <div>Hints: <span id="hints-remaining">3</span> remaining</div>
                </div>
                
                <div class="clue-container">
                    <h3>Identify the Surah:</h3>
                    <div id="clues-list">
                        <div class="clue-text" id="clue-1">This surah is Makki and has 7 verses.</div>
                    </div>
                    <button id="use-hint-btn">Use a Hint</button>
                </div>
                
                <div id="multiple-choice-container">
                    <div class="options-container" id="options-container">
                        <!-- Options will be dynamically added here -->
                    </div>
                </div>
                
                <div id="type-in-container" style="display: none;">
                    <input type="text" id="answer-input" placeholder="Type the name of the Surah..." list="surah-list">
                    <datalist id="surah-list">
                        <!-- Surah names will be added here -->
                    </datalist>
                    <button id="submit-answer-btn" class="btn-primary">Submit Answer</button>
                </div>
                
                <div id="result-feedback" style="display: none; margin-top: 20px; padding: 15px; border-radius: 10px;">
                    <h3 id="result-text">Correct!</h3>
                    <p id="result-detail"></p>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button id="next-question-btn" style="display: none;">Next Question</button>
                    <button id="quit-game-btn" class="btn-accent">Quit Game</button>
                </div>
            </div>
        </div>
        
        <!-- Game Results Screen -->
        <div id="results-screen" class="screen">
            <div class="card">
                <h2>Game Results</h2>
                <div class="score-display">
                    Your Score: <span id="final-score" class="score-number">0</span>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="correct-answers">0</div>
                        <div class="stat-label">Correct</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="incorrect-answers">0</div>
                        <div class="stat-label">Incorrect</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="hints-used">0</div>
                        <div class="stat-label">Hints Used</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="accuracy-percentage">0%</div>
                        <div class="stat-label">Accuracy</div>
                    </div>
                </div>
                <div id="results-detail" style="margin-top: 20px;">
                    <h3>Summary</h3>
                    <ul id="question-summary">
                        <!-- Summary items will be added here -->
                    </ul>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button id="play-again-btn" class="btn-primary">Play Again</button>
                    <button id="back-to-home-btn">Back to Home</button>
                </div>
            </div>
        </div>
        
        <!-- Learn Mode Screen -->
        <div id="learn-screen" class="screen">
            <div class="card">
                <h2>Learn Mode</h2>
                <p>Browse information about all 114 Surahs of the Holy Quran.</p>
                
                <div style="margin: 20px 0;">
                    <input type="text" id="search-surah" placeholder="Search for a Surah...">
                </div>
                
                <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;">
                    <button id="juz-filter-all" class="filter-btn active">All</button>
                    <button id="juz-filter-1-10" class="filter-btn">Juz 1-10</button>
                    <button id="juz-filter-11-20" class="filter-btn">Juz 11-20</button>
                    <button id="juz-filter-21-30" class="filter-btn">Juz 21-30</button>
                    <button id="filter-makki" class="filter-btn">Makki</button>
                    <button id="filter-madani" class="filter-btn">Madani</button>
                </div>
                
                <div id="surah-list-container" style="max-height: 400px; overflow-y: auto; margin: 20px 0;">
                    <!-- Surah cards will be added here -->
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button id="learn-back-btn">Back to Home</button>
                </div>
            </div>
        </div>
        
        <!-- Settings Screen -->
        <div id="settings-screen" class="screen">
            <div class="card">
                <h2>Settings</h2>
                
                <div class="settings-grid">
                    <div class="setting-card">
                        <div class="setting-title">Data Management</div>
                        <button id="export-data-btn">Export Progress Data</button>
                        <button id="import-data-btn">Import Progress Data</button>
                        <button id="reset-data-btn" class="btn-accent">Reset All Data</button>
                    </div>
                    <div class="setting-card">
                        <div class="setting-title">App Preferences</div>
                        <div style="margin: 10px 0;">
                            <label>
                                <input type="checkbox" id="sound-effects-toggle" checked>
                                Sound Effects
                            </label>
                        </div>
                        <div style="margin: 10px 0;">
                            <label>
                                <input type="checkbox" id="auto-hints-toggle" checked>
                                Auto Show Hints on Incorrect
                            </label>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button id="settings-back-btn">Back to Home</button>
                </div>
            </div>
        </div>
        
        <!-- Surah Detail Modal -->
        <div id="surah-detail-modal" class="modal">
            <div class="modal-content">
                <span class="close-modal" id="close-surah-modal">&times;</span>
                <h2 id="modal-surah-name"></h2>
                <div class="arabic-text" id="modal-surah-arabic"></div>
                <div id="modal-surah-details">
                    <!-- Surah details will be added here -->
                </div>
                <div id="modal-surah-ayahs">
                    <!-- Sample ayahs will be added here -->
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button id="practice-this-surah-btn" class="btn-primary">Practice This Surah</button>
                </div>
            </div>
        </div>
        
        <div class="footer">
            Surah Challenge © 2025 | For educational purposes | Developed with ❤️
        </div>
    </div>
    
    <script>
        // DB and Data Handling
        const DB_NAME = 'SurahChallengeDB';
        const DB_VERSION = 1;
        let db;
        let gameState = {
            currentQuestion: 0,
            score: 0,
            hintsRemaining: 3,
            hintsUsed: 0,
            correctAnswers: 0,
            incorrectAnswers: 0,
            questions: [],
            results: [],
            settings: {
                difficulty: 'medium',
                questionType: 'multiple-choice',
                questionCount: 10,
                focusArea: 'all',
                soundEffects: true,
                autoHints: true
            }
        };
        
        // Surah Data
        // Surah Data
const surahs = [
    { id: 1, name: "Al-Fatiha", arabicName: "الفاتحة", ayahs: 7, type: "Makki", meaning: "The Opening", juz: 1 },
    { id: 2, name: "Al-Baqarah", arabicName: "البقرة", ayahs: 286, type: "Madani", meaning: "The Cow", juz: 1 },
    { id: 3, name: "Aal-Imran", arabicName: "آل عمران", ayahs: 200, type: "Madani", meaning: "The Family of Imran", juz: 3 },
    { id: 4, name: "An-Nisa", arabicName: "النساء", ayahs: 176, type: "Madani", meaning: "The Women", juz: 4 },
    { id: 5, name: "Al-Ma'idah", arabicName: "المائدة", ayahs: 120, type: "Madani", meaning: "The Table Spread", juz: 6 },
    { id: 6, name: "Al-An'am", arabicName: "الأنعام", ayahs: 165, type: "Makki", meaning: "The Cattle", juz: 7 },
    { id: 7, name: "Al-A'raf", arabicName: "الأعراف", ayahs: 206, type: "Makki", meaning: "The Heights", juz: 8 },
    { id: 8, name: "Al-Anfal", arabicName: "الأنفال", ayahs: 75, type: "Madani", meaning: "The Spoils of War", juz: 9 },
    { id: 9, name: "At-Tawbah", arabicName: "التوبة", ayahs: 129, type: "Madani", meaning: "The Repentance", juz: 10 },
    { id: 10, name: "Yunus", arabicName: "يونس", ayahs: 109, type: "Makki", meaning: "Jonah", juz: 11 },
    { id: 11, name: "Hud", arabicName: "هود", ayahs: 123, type: "Makki", meaning: "Hud", juz: 11 },
    { id: 12, name: "Yusuf", arabicName: "يوسف", ayahs: 111, type: "Makki", meaning: "Joseph", juz: 12 },
    { id: 13, name: "Ar-Ra'd", arabicName: "الرعد", ayahs: 43, type: "Madani", meaning: "The Thunder", juz: 13 },
    { id: 14, name: "Ibrahim", arabicName: "إبراهيم", ayahs: 52, type: "Makki", meaning: "Abraham", juz: 13 },
    { id: 15, name: "Al-Hijr", arabicName: "الحجر", ayahs: 99, type: "Makki", meaning: "The Rocky Tract", juz: 14 },
    { id: 16, name: "An-Nahl", arabicName: "النحل", ayahs: 128, type: "Makki", meaning: "The Bee", juz: 14 },
    { id: 17, name: "Al-Isra", arabicName: "الإسراء", ayahs: 111, type: "Makki", meaning: "The Night Journey", juz: 15 },
    { id: 18, name: "Al-Kahf", arabicName: "الكهف", ayahs: 110, type: "Makki", meaning: "The Cave", juz: 15 },
    { id: 19, name: "Maryam", arabicName: "مريم", ayahs: 98, type: "Makki", meaning: "Mary", juz: 16 },
    { id: 20, name: "Ta-Ha", arabicName: "طه", ayahs: 135, type: "Makki", meaning: "Ta-Ha", juz: 16 },
    { id: 21, name: "Al-Anbiya", arabicName: "الأنبياء", ayahs: 112, type: "Makki", meaning: "The Prophets", juz: 17 },
    { id: 22, name: "Al-Hajj", arabicName: "الحج", ayahs: 78, type: "Madani", meaning: "The Pilgrimage", juz: 17 },
    { id: 23, name: "Al-Mu'minun", arabicName: "المؤمنون", ayahs: 118, type: "Makki", meaning: "The Believers", juz: 18 },
    { id: 24, name: "An-Nur", arabicName: "النور", ayahs: 64, type: "Madani", meaning: "The Light", juz: 18 },
    { id: 25, name: "Al-Furqan", arabicName: "الفرقان", ayahs: 77, type: "Makki", meaning: "The Criterion", juz: 19 },
    { id: 26, name: "Ash-Shu'ara", arabicName: "الشعراء", ayahs: 227, type: "Makki", meaning: "The Poets", juz: 19 },
    { id: 27, name: "An-Naml", arabicName: "النمل", ayahs: 93, type: "Makki", meaning: "The Ants", juz: 19 },
    { id: 28, name: "Al-Qasas", arabicName: "القصص", ayahs: 88, type: "Makki", meaning: "The Stories", juz: 20 },
    { id: 29, name: "Al-Ankabut", arabicName: "العنكبوت", ayahs: 69, type: "Makki", meaning: "The Spider", juz: 20 },
    { id: 30, name: "Ar-Rum", arabicName: "الروم", ayahs: 60, type: "Makki", meaning: "The Romans", juz: 21 },
    { id: 31, name: "Luqman", arabicName: "لقمان", ayahs: 34, type: "Makki", meaning: "Luqman", juz: 21 },
    { id: 32, name: "As-Sajdah", arabicName: "السجدة", ayahs: 30, type: "Makki", meaning: "The Prostration", juz: 21 },
    { id: 33, name: "Al-Ahzab", arabicName: "الأحزاب", ayahs: 73, type: "Madani", meaning: "The Combined Forces", juz: 21 },
    { id: 34, name: "Saba", arabicName: "سبإ", ayahs: 54, type: "Makki", meaning: "Sheba", juz: 22 },
    { id: 35, name: "Fatir", arabicName: "فاطر", ayahs: 45, type: "Makki", meaning: "Originator", juz: 22 },
    { id: 36, name: "Ya-Sin", arabicName: "يس", ayahs: 83, type: "Makki", meaning: "Ya Sin", juz: 22 },
    { id: 37, name: "As-Saffat", arabicName: "الصافات", ayahs: 182, type: "Makki", meaning: "Those who set the Ranks", juz: 23 },
    { id: 38, name: "Sad", arabicName: "ص", ayahs: 88, type: "Makki", meaning: "The Letter Sad", juz: 23 },
    { id: 39, name: "Az-Zumar", arabicName: "الزمر", ayahs: 75, type: "Makki", meaning: "The Troops", juz: 23 },
    { id: 40, name: "Ghafir", arabicName: "غافر", ayahs: 85, type: "Makki", meaning: "The Forgiver", juz: 24 },
    { id: 41, name: "Fussilat", arabicName: "فصلت", ayahs: 54, type: "Makki", meaning: "Explained in Detail", juz: 24 },
    { id: 42, name: "Ash-Shura", arabicName: "الشورى", ayahs: 53, type: "Makki", meaning: "The Consultation", juz: 25 },
    { id: 43, name: "Az-Zukhruf", arabicName: "الزخرف", ayahs: 89, type: "Makki", meaning: "The Ornaments of Gold", juz: 25 },
    { id: 44, name: "Ad-Dukhan", arabicName: "الدخان", ayahs: 59, type: "Makki", meaning: "The Smoke", juz: 25 },
    { id: 45, name: "Al-Jathiyah", arabicName: "الجاثية", ayahs: 37, type: "Makki", meaning: "The Kneeling", juz: 25 },
    { id: 46, name: "Al-Ahqaf", arabicName: "الأحقاف", ayahs: 35, type: "Makki", meaning: "The Wind-Curved Sandhills", juz: 26 },
    { id: 47, name: "Muhammad", arabicName: "محمد", ayahs: 38, type: "Madani", meaning: "Muhammad", juz: 26 },
    { id: 48, name: "Al-Fath", arabicName: "الفتح", ayahs: 29, type: "Madani", meaning: "The Victory", juz: 26 },
    { id: 49, name: "Al-Hujurat", arabicName: "الحجرات", ayahs: 18, type: "Madani", meaning: "The Rooms", juz: 26 },
    { id: 50, name: "Qaf", arabicName: "ق", ayahs: 45, type: "Makki", meaning: "The Letter Qaf", juz: 26 },
    { id: 51, name: "Adh-Dhariyat", arabicName: "الذاريات", ayahs: 60, type: "Makki", meaning: "The Winnowing Winds", juz: 26 },
    { id: 52, name: "At-Tur", arabicName: "الطور", ayahs: 49, type: "Makki", meaning: "The Mount", juz: 27 },
    { id: 53, name: "An-Najm", arabicName: "النجم", ayahs: 62, type: "Makki", meaning: "The Star", juz: 27 },
    { id: 54, name: "Al-Qamar", arabicName: "القمر", ayahs: 55, type: "Makki", meaning: "The Moon", juz: 27 },
    { id: 55, name: "Ar-Rahman", arabicName: "الرحمن", ayahs: 78, type: "Madani", meaning: "The Beneficent", juz: 27 },
    { id: 56, name: "Al-Waqi'ah", arabicName: "الواقعة", ayahs: 96, type: "Makki", meaning: "The Inevitable", juz: 27 },
    { id: 57, name: "Al-Hadid", arabicName: "الحديد", ayahs: 29, type: "Madani", meaning: "The Iron", juz: 27 },
    { id: 58, name: "Al-Mujadila", arabicName: "المجادلة", ayahs: 22, type: "Madani", meaning: "The Pleading Woman", juz: 28 },
    { id: 59, name: "Al-Hashr", arabicName: "الحشر", ayahs: 24, type: "Madani", meaning: "The Exile", juz: 28 },
    { id: 60, name: "Al-Mumtahinah", arabicName: "الممتحنة", ayahs: 13, type: "Madani", meaning: "She That is to be Examined", juz: 28 },
    { id: 61, name: "As-Saff", arabicName: "الصف", ayahs: 14, type: "Madani", meaning: "The Ranks", juz: 28 },
    { id: 62, name: "Al-Jumu'ah", arabicName: "الجمعة", ayahs: 11, type: "Madani", meaning: "The Congregation", juz: 28 },
    { id: 63, name: "Al-Munafiqun", arabicName: "المنافقون", ayahs: 11, type: "Madani", meaning: "The Hypocrites", juz: 28 },
    { id: 64, name: "At-Taghabun", arabicName: "التغابن", ayahs: 18, type: "Madani", meaning: "The Mutual Disillusion", juz: 28 },
    { id: 65, name: "At-Talaq", arabicName: "الطلاق", ayahs: 12, type: "Madani", meaning: "The Divorce", juz: 28 },
    { id: 66, name: "At-Tahrim", arabicName: "التحريم", ayahs: 12, type: "Madani", meaning: "The Prohibition", juz: 28 },
    { id: 67, name: "Al-Mulk", arabicName: "الملك", ayahs: 30, type: "Makki", meaning: "The Sovereignty", juz: 29 },
    { id: 68, name: "Al-Qalam", arabicName: "القلم", ayahs: 52, type: "Makki", meaning: "The Pen", juz: 29 },
    { id: 69, name: "Al-Haqqah", arabicName: "الحاقة", ayahs: 52, type: "Makki", meaning: "The Reality", juz: 29 },
    { id: 70, name: "Al-Ma'arij", arabicName: "المعارج", ayahs: 44, type: "Makki", meaning: "The Ascending Stairways", juz: 29 },
    { id: 71, name: "Nuh", arabicName: "نوح", ayahs: 28, type: "Makki", meaning: "Noah", juz: 29 },
    { id: 72, name: "Al-Jinn", arabicName: "الجن", ayahs: 28, type: "Makki", meaning: "The Jinn", juz: 29 },
    { id: 73, name: "Al-Muzzammil", arabicName: "المزمل", ayahs: 20, type: "Makki", meaning: "The Enshrouded One", juz: 29 },
    { id: 74, name: "Al-Muddaththir", arabicName: "المدثر", ayahs: 56, type: "Makki", meaning: "The Cloaked One", juz: 29 },
    { id: 75, name: "Al-Qiyamah", arabicName: "القيامة", ayahs: 40, type: "Makki", meaning: "The Resurrection", juz: 29 },
    { id: 76, name: "Al-Insan", arabicName: "الإنسان", ayahs: 31, type: "Madani", meaning: "The Man", juz: 29 },
    { id: 77, name: "Al-Mursalat", arabicName: "المرسلات", ayahs: 50, type: "Makki", meaning: "Those Sent Forth", juz: 29 },
    { id: 78, name: "An-Naba", arabicName: "النبإ", ayahs: 40, type: "Makki", meaning: "The Announcement", juz: 30 },
    { id: 79, name: "An-Nazi'at", arabicName: "النازعات", ayahs: 46, type: "Makki", meaning: "Those who Pull Out", juz: 30 },
    { id: 80, name: "Abasa", arabicName: "عبس", ayahs: 42, type: "Makki", meaning: "He Frowned", juz: 30 },
    { id: 81, name: "At-Takwir", arabicName: "التكوير", ayahs: 29, type: "Makki", meaning: "The Overthrowing", juz: 30 },
    { id: 82, name: "Al-Infitar", arabicName: "الانفطار", ayahs: 19, type: "Makki", meaning: "The Cleaving", juz: 30 },
    { id: 83, name: "Al-Mutaffifin", arabicName: "المطففين", ayahs: 36, type: "Makki", meaning: "The Defrauding", juz: 30 },
    { id: 84, name: "Al-Inshiqaq", arabicName: "الانشقاق", ayahs: 25, type: "Makki", meaning: "The Splitting Open", juz: 30 },
    { id: 85, name: "Al-Buruj", arabicName: "البروج", ayahs: 22, type: "Makki", meaning: "The Mansions of the Stars", juz: 30 },
    { id: 86, name: "At-Tariq", arabicName: "الطارق", ayahs: 17, type: "Makki", meaning: "The Morning Star", juz: 30 },
    { id: 87, name: "Al-A'la", arabicName: "الأعلى", ayahs: 19, type: "Makki", meaning: "The Most High", juz: 30 },
    { id: 88, name: "Al-Ghashiyah", arabicName: "الغاشية", ayahs: 26, type: "Makki", meaning: "The Overwhelming", juz: 30 },
    { id: 89, name: "Al-Fajr", arabicName: "الفجر", ayahs: 30, type: "Makki", meaning: "The Dawn", juz: 30 },
    { id: 90, name: "Al-Balad", arabicName: "البلد", ayahs: 20, type: "Makki", meaning: "The City", juz: 30 },
    { id: 91, name: "Ash-Shams", arabicName: "الشمس", ayahs: 15, type: "Makki", meaning: "The Sun", juz: 30 },
    { id: 92, name: "Al-Layl", arabicName: "الليل", ayahs: 21, type: "Makki", meaning: "The Night", juz: 30 },
    { id: 93, name: "Ad-Duha", arabicName: "الضحى", ayahs: 11, type: "Makki", meaning: "The Morning Hours", juz: 30 },
    { id: 94, name: "Ash-Sharh", arabicName: "الشرح", ayahs: 8, type: "Makki", meaning: "The Relief", juz: 30 },
    { id: 95, name: "At-Tin", arabicName: "التين", ayahs: 8, type: "Makki", meaning: "The Fig", juz: 30 },
    { id: 96, name: "Al-Alaq", arabicName: "العلق", ayahs: 19, type: "Makki", meaning: "The Clot", juz: 30 },
    { id: 97, name: "Al-Qadr", arabicName: "القدر", ayahs: 5, type: "Makki", meaning: "The Power", juz: 30 },
    { id: 98, name: "Al-Bayyinah", arabicName: "البينة", ayahs: 8, type: "Madani", meaning: "The Clear Proof", juz: 30 },
    { id: 99, name: "Az-Zalzalah", arabicName: "الزلزلة", ayahs: 8, type: "Madani", meaning: "The Earthquake", juz: 30 },
    { id: 100, name: "Al-Adiyat", arabicName: "العاديات", ayahs: 11, type: "Makki", meaning: "The Courser", juz: 30 },
    { id: 101, name: "Al-Qari'ah", arabicName: "القارعة", ayahs: 11, type: "Makki", meaning: "The Calamity", juz: 30 },
    { id: 102, name: "At-Takathur", arabicName: "التكاثر", ayahs: 8, type: "Makki", meaning: "The Abundance", juz: 30 },
    { id: 103, name: "Al-Asr", arabicName: "العصر", ayahs: 3, type: "Makki", meaning: "The Declining Day", juz: 30 },
    { id: 104, name: "Al-Humazah", arabicName: "الهمزة", ayahs: 9, type: "Makki", meaning: "The Traducer", juz: 30 },
    { id: 105, name: "Al-Fil", arabicName: "الفيل", ayahs: 5, type: "Makki", meaning: "The Elephant", juz: 30 },
    { id: 106, name: "Quraysh", arabicName: "قريش", ayahs: 4, type: "Makki", meaning: "Quraysh", juz: 30 },
    { id: 107, name: "Al-Ma'un", arabicName: "الماعون", ayahs: 7, type: "Makki", meaning: "The Small Kindnesses", juz: 30 },
    { id: 108, name: "Al-Kawthar", arabicName: "الكوثر", ayahs: 3, type: "Makki", meaning: "The Abundance", juz: 30 },
    { id: 109, name: "Al-Kafirun", arabicName: "الكافرون", ayahs: 6, type: "Makki", meaning: "The Disbelievers", juz: 30 },
    { id: 110, name: "An-Nasr", arabicName: "النصر", ayahs: 3, type: "Madani", meaning: "The Divine Support", juz: 30 },
    { id: 111, name: "Al-Masad", arabicName: "المسد", ayahs: 5, type: "Makki", meaning: "The Palm Fiber", juz: 30 },
    { id: 112, name: "Al-Ikhlas", arabicName: "الإخلاص", ayahs: 4, type: "Makki", meaning: "The Sincerity", juz: 30 },
    { id: 113, name: "Al-Falaq", arabicName: "الفلق", ayahs: 5, type: "Makki", meaning: "The Daybreak", juz: 30 },
    { id: 114, name: "An-Nas", arabicName: "الناس", ayahs: 6, type: "Makki", meaning: "The Mankind", juz: 30 }
];

        
        // Clue types for different difficulties
        const clueTypes = {
            easy: [
                { type: "ayahCount", weight: 10 },
                { type: "surahType", weight: 10 },
                { type: "meaning", weight: 8 },
                { type: "juzNumber", weight: 8 },
                { type: "position", weight: 8 },
                { type: "famousAyah", weight: 15 }
            ],
            medium: [
                { type: "ayahCount", weight: 6 },
                { type: "surahType", weight: 6 },
                { type: "meaning", weight: 6 },
                { type: "juzNumber", weight: 6 },
                { type: "position", weight: 6 },
                { type: "famousAyah", weight: 10 },
                { type: "theme", weight: 10 },
                { type: "startsWith", weight: 8 }
            ],
            hard: [
                { type: "ayahCount", weight: 4 },
                { type: "surahType", weight: 4 },
                { type: "meaning", weight: 4 },
                { type: "juzNumber", weight: 4 },
                { type: "position", weight: 4 },
                { type: "theme", weight: 10 },
                { type: "startsWith", weight: 8 },
                { type: "distinctiveWord", weight: 8 },
                { type: "historicalContext", weight: 10 }
            ]
        };
        
        // Our Quran data from the user
        let quranData = [];
        let myJourneyData = {}; // Will store information about which surahs the user is learning
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            showScreen('loading-screen');
            updateLoadingStatus('Setting up database...');
            
            // Initialize IndexedDB
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            
            request.onupgradeneeded = function(event) {
                db = event.target.result;
                
                // Create object stores
                if (!db.objectStoreNames.contains('userData')) {
                    const userDataStore = db.createObjectStore('userData', { keyPath: 'id' });
                }
                
                if (!db.objectStoreNames.contains('quranData')) {
                    const quranDataStore = db.createObjectStore('quranData', { keyPath: 'id', autoIncrement: true });
                    quranDataStore.createIndex('surah', 'surah', { unique: false });
                    quranDataStore.createIndex('ayah', 'ayah', { unique: false });
                }
                
                if (!db.objectStoreNames.contains('gameProgress')) {
                    const gameProgressStore = db.createObjectStore('gameProgress', { keyPath: 'id', autoIncrement: true });
                    gameProgressStore.createIndex('date', 'date', { unique: false });
                }
                
                if (!db.objectStoreNames.contains('surahProgress')) {
                    const surahProgressStore = db.createObjectStore('surahProgress', { keyPath: 'surahId' });
                }
            };
            
            request.onsuccess = function(event) {
                db = event.target.result;
                updateLoadingStatus('Database ready...');
                
                // Load user settings
                loadUserSettings();
                
                // Try to load Quran data file
                loadQuranDataFile();
            };
            
            request.onerror = function(event) {
                console.error('IndexedDB error:', event.target.error);
                updateLoadingStatus('Error setting up database. Please refresh the page.');
            };
            
            // Set up event listeners for all buttons
            setupEventListeners();
            
            // Populate surah list for datalist
            populateSurahList();
        });
        
        // Load Quran data file
        function loadQuranDataFile() {
            updateLoadingStatus('Checking for Quran data...');
            
            // First check if we already have data in IndexedDB
            const transaction = db.transaction(['quranData'], 'readonly');
            const store = transaction.objectStore('quranData');
            const countRequest = store.count();
            
            countRequest.onsuccess = function() {
                if (countRequest.result > 0) {
                    updateLoadingStatus('Loading Quran data from database...');
                    
                    // We already have data, load it
                    const getAllRequest = store.getAll();
                    
                    getAllRequest.onsuccess = function() {
                        quranData = getAllRequest.result;
                        updateLoadingStatus('Quran data loaded successfully!');
                        processQuranData();
                    };
                    
                    getAllRequest.onerror = function(event) {
                        console.error('Error loading Quran data:', event.target.error);
                        updateLoadingStatus('Error loading Quran data. Trying to load from file...');
                        loadDataFromFile();
                    };
                } else {
                    // No data in database, try to load from file
                    updateLoadingStatus('No Quran data found in database. Trying to load from file...');
                    loadDataFromFile();
                }
            };
            
            countRequest.onerror = function(event) {
                console.error('Error checking Quran data count:', event.target.error);
                updateLoadingStatus('Error checking database. Trying to load from file...');
                loadDataFromFile();
            };
        }
        
        // Load data from external file
// Load data from external file
function loadDataFromFile() {
    updateLoadingStatus('Loading Quran data file...');
    
    fetch('data.AM')
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.text();
        })
        .then(data => {
            updateLoadingStatus('Processing Quran data...');
            
            // Parse the data
            const lines = data.split('\n');
            const parsedData = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // Parse the line
                // Format: [Arabic Ayah] ترجمہ: [Urdu Translation]<br/>س [Surah Number] آ [Ayah Number]
                const translationSplit = line.split('ترجمہ:');
                if (translationSplit.length < 2) continue;
                
                const arabicText = translationSplit[0].trim();
                
                const metadataText = translationSplit[1];
                const metadataSplit = metadataText.split('<br/>س');
                if (metadataSplit.length < 2) continue;
                
                const urduTranslation = metadataSplit[0].trim();
                
                const surahAyahPart = metadataSplit[1].trim();
                const surahAyahSplit = surahAyahPart.split('آ');
                if (surahAyahSplit.length < 2) continue;
                
                const surahNumber = parseInt(surahAyahSplit[0].trim());
                const ayahNumber = parseInt(surahAyahSplit[1].trim());
                
                parsedData.push({
                    id: `${surahNumber.toString().padStart(3, '0')}_${ayahNumber.toString().padStart(3, '0')}`,
                    arabic: arabicText,
                    urdu: urduTranslation,
                    surah: surahNumber,
                    ayah: ayahNumber
                });
            }
            
            // Store data in IndexedDB
            const transaction = db.transaction(['quranData'], 'readwrite');
            const store = transaction.objectStore('quranData');
            
            // Clear existing data
            store.clear();
            
            // Add each ayah to the database
            let completed = 0;
            for (let i = 0; i < parsedData.length; i++) {
                const request = store.add(parsedData[i]);
                
                request.onsuccess = function() {
                    completed++;
                    if (completed % 100 === 0 || completed === parsedData.length) {
                        updateLoadingStatus(`Storing data: ${completed}/${parsedData.length} ayahs...`);
                    }
                    
                    if (completed === parsedData.length) {
                        quranData = parsedData;
                        processQuranData();
                    }
                };
                
                request.onerror = function(event) {
                    console.error('Error adding ayah to database:', event.target.error);
                };
            }
            
            transaction.oncomplete = function() {
                console.log('All Quran data stored in IndexedDB');
            };
            
            transaction.onerror = function(event) {
                console.error('Transaction error:', event.target.error);
                updateLoadingStatus('Error storing Quran data.');
            };
        })
        .catch(error => {
            console.error('Error loading Quran data file:', error);
            updateLoadingStatus('Could not load Quran data file. Starting with limited functionality.');
            finishLoading();
        });
}

        
        // Process the Quran data to extract journey information
        function processQuranData() {
            updateLoadingStatus('Analyzing your Quran journey...');
            
            // Group ayahs by surah to see which surahs the user has data for
            const surahCounts = {};
            quranData.forEach(ayah => {
                if (!surahCounts[ayah.surah]) {
                    surahCounts[ayah.surah] = 0;
                }
                surahCounts[ayah.surah]++;
            });
            
            // Calculate coverage percentage for each surah
            surahs.forEach(surah => {
                const ayahsInJourney = surahCounts[surah.id] || 0;
                const coveragePercent = (ayahsInJourney / surah.ayahs) * 100;
                myJourneyData[surah.id] = {
                    inJourney: ayahsInJourney > 0,
                    ayahsInJourney: ayahsInJourney,
                    coverage: coveragePercent,
                    totalAyahs: surah.ayahs
                };
            });
            
            // Initialize surah progress if not already done
            initializeSurahProgress();
            
            updateLoadingStatus('Starting Surah Challenge...');
            finishLoading();
        }
        
        // Initialize surah progress data if not already done
        function initializeSurahProgress() {
            const transaction = db.transaction(['surahProgress'], 'readonly');
            const store = transaction.objectStore('surahProgress');
            const countRequest = store.count();
            
            countRequest.onsuccess = function() {
                if (countRequest.result === 0) {
                    // No progress data, initialize it
                    const writeTx = db.transaction(['surahProgress'], 'readwrite');
const writeStore = writeTx.objectStore('surahProgress');

                    surahs.forEach(surah => {
                        writeStore.add({
                            surahId: surah.id,
                            name: surah.name,
                            arabicName: surah.arabicName,
                            timesCorrect: 0,
                            timesIncorrect: 0,
                            lastAttempted: null,
                            mastered: false
                        });
                    });
                }
            };
        }
        
        // Finish loading and show welcome screen
        function finishLoading() {
            // Update stats on welcome screen
            updateHomeStats();
            
            // Show welcome screen
            setTimeout(() => {
                showScreen('welcome-screen');
            }, 500);
        }
        
        // Update loading status message
        function updateLoadingStatus(message) {
            document.getElementById('loading-status').textContent = message;
        }
        
        // Load user settings from IndexedDB
        function loadUserSettings() {
            const transaction = db.transaction(['userData'], 'readonly');
            const store = transaction.objectStore('userData');
            const request = store.get('settings');
            
            request.onsuccess = function() {
                if (request.result) {
                    gameState.settings = request.result.data;
                    
                    // Apply settings to UI
                    document.getElementById('sound-effects-toggle').checked = gameState.settings.soundEffects;
                    document.getElementById('auto-hints-toggle').checked = gameState.settings.autoHints;
                    document.getElementById('difficulty-select').value = gameState.settings.difficulty;
                    document.getElementById('question-type-select').value = gameState.settings.questionType;
                    document.getElementById('question-count-select').value = gameState.settings.questionCount;
                    document.getElementById('focus-area-select').value = gameState.settings.focusArea;
                }
            };
        }
        
        // Save user settings to IndexedDB
        function saveUserSettings() {
            const transaction = db.transaction(['userData'], 'readwrite');
            const store = transaction.objectStore('userData');
            
            const settings = {
                id: 'settings',
                data: gameState.settings
            };
            
            store.put(settings);
        }
        
        // Set up all event listeners
        function setupEventListeners() {
            // Welcome screen buttons
            document.getElementById('start-game-btn').addEventListener('click', () => showScreen('game-setup-screen'));
            document.getElementById('learn-mode-btn').addEventListener('click', () => {
                loadLearnMode();
                showScreen('learn-screen');
            });
            document.getElementById('settings-btn').addEventListener('click', () => showScreen('settings-screen'));
            
            // Setup screen buttons
            document.getElementById('start-game-now-btn').addEventListener('click', startGame);
            document.getElementById('back-to-main-btn').addEventListener('click', () => showScreen('welcome-screen'));
            
            // Game screen buttons
            document.getElementById('use-hint-btn').addEventListener('click', useHint);
            document.getElementById('submit-answer-btn').addEventListener('click', checkTypeInAnswer);
            document.getElementById('next-question-btn').addEventListener('click', nextQuestion);
            document.getElementById('quit-game-btn').addEventListener('click', quitGame);
            
            // Results screen buttons
            document.getElementById('play-again-btn').addEventListener('click', () => showScreen('game-setup-screen'));
            document.getElementById('back-to-home-btn').addEventListener('click', () => showScreen('welcome-screen'));
            
            // Learn mode buttons
            document.getElementById('learn-back-btn').addEventListener('click', () => showScreen('welcome-screen'));
            document.getElementById('search-surah').addEventListener('input', filterSurahs);
            document.getElementById('juz-filter-all').addEventListener('click', () => filterSurahsByJuz('all'));
            document.getElementById('juz-filter-1-10').addEventListener('click', () => filterSurahsByJuz('1-10'));
            document.getElementById('juz-filter-11-20').addEventListener('click', () => filterSurahsByJuz('11-20'));
            document.getElementById('juz-filter-21-30').addEventListener('click', () => filterSurahsByJuz('21-30'));
            document.getElementById('filter-makki').addEventListener('click', () => filterSurahsByType('Makki'));
            document.getElementById('filter-madani').addEventListener('click', () => filterSurahsByType('Madani'));
            
            // Settings buttons
            document.getElementById('settings-back-btn').addEventListener('click', () => showScreen('welcome-screen'));
            document.getElementById('export-data-btn').addEventListener('click', exportProgressData);
            document.getElementById('import-data-btn').addEventListener('click', importProgressData);
            document.getElementById('reset-data-btn').addEventListener('click', confirmResetData);
            
            // Settings toggles
            document.getElementById('sound-effects-toggle').addEventListener('change', function() {
                gameState.settings.soundEffects = this.checked;
                saveUserSettings();
            });
            
            document.getElementById('auto-hints-toggle').addEventListener('change', function() {
                gameState.settings.autoHints = this.checked;
                saveUserSettings();
            });
            
            // Game setup selects
            document.getElementById('difficulty-select').addEventListener('change', function() {
                gameState.settings.difficulty = this.value;
                saveUserSettings();
            });
            
            document.getElementById('question-type-select').addEventListener('change', function() {
                gameState.settings.questionType = this.value;
                saveUserSettings();
            });
            
            document.getElementById('question-count-select').addEventListener('change', function() {
                gameState.settings.questionCount = parseInt(this.value);
                saveUserSettings();
            });
            
            document.getElementById('focus-area-select').addEventListener('change', function() {
                gameState.settings.focusArea = this.value;
                saveUserSettings();
            });
            
            // Modal close button
            document.getElementById('close-surah-modal').addEventListener('click', hideModal);
        }
        
        // Populate surah list for datalist
        function populateSurahList() {
            const datalist = document.getElementById('surah-list');
            
            surahs.forEach(surah => {
                const option = document.createElement('option');
                option.value = surah.name;
                datalist.appendChild(option);
            });
        }
        
        // Show a specific screen
        function showScreen(screenId) {
            // Hide all screens
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active-screen');
            });
            
            // Show the requested screen
            document.getElementById(screenId).classList.add('active-screen');
            
            // Special handling for specific screens
            if (screenId === 'welcome-screen') {
                updateHomeStats();
            }
        }
        
        // Update stats on home screen
        function updateHomeStats() {
            const transaction = db.transaction(['gameProgress', 'surahProgress'], 'readonly');
            const gameStore = transaction.objectStore('gameProgress');
            const surahStore = transaction.objectStore('surahProgress');
            
            // Get total questions completed
            const questionsRequest = gameStore.count();
            questionsRequest.onsuccess = function() {
                document.getElementById('total-questions-completed').textContent = questionsRequest.result;
            };
            
            // Get highest score
            const getAllGamesRequest = gameStore.getAll();
            getAllGamesRequest.onsuccess = function() {
                const games = getAllGamesRequest.result;
                let highestScore = 0;
                
                if (games.length > 0) {
                    highestScore = Math.max(...games.map(game => game.score));
                }
                
                document.getElementById('highest-score').textContent = highestScore;
            };
            
            // Get surahs learned
            const surahCountRequest = surahStore.count();
            const surahsLearnedRequest = surahStore.openCursor();
            let surahsLearned = 0;
            
            surahsLearnedRequest.onsuccess = function(event) {
                const cursor = event.target.result;
                if (cursor) {
                    if (cursor.value.timesCorrect > 0) {
                        surahsLearned++;
                    }
                    cursor.continue();
                } else {
                    document.getElementById('total-surahs-learned').textContent = `${surahsLearned}/114`;
                }
            };
        }
        
        // Start a new game
        function startGame() {
            // Reset game state
            gameState.currentQuestion = 0;
            gameState.score = 0;
            gameState.hintsRemaining = 3;
            gameState.hintsUsed = 0;
            gameState.correctAnswers = 0;
            gameState.incorrectAnswers = 0;
            gameState.questions = [];
            gameState.results = [];
            
            // Update UI
            document.getElementById('current-question').textContent = '1';
            document.getElementById('total-questions').textContent = gameState.settings.questionCount;
            document.getElementById('current-score').textContent = '0';
            document.getElementById('hints-remaining').textContent = gameState.hintsRemaining;
            
            // Generate questions
            generateQuestions();
            
            // Show game screen
            showScreen('game-screen');
            
            // Display first question
            displayQuestion(0);
        }
        
        // Generate questions for the game
        function generateQuestions() {
            const questionCount = gameState.settings.questionCount;
            const focusArea = gameState.settings.focusArea;
            const difficulty = gameState.settings.difficulty;
            
            // Filter surahs based on focus area
            let surahPool = [];
            
            if (focusArea === 'all') {
                surahPool = [...surahs];
            } else if (focusArea === 'my-journey') {
                surahPool = surahs.filter(surah => myJourneyData[surah.id] && myJourneyData[surah.id].inJourney);
                
                // If no surahs in journey, fall back to all surahs
                if (surahPool.length === 0) {
                    surahPool = [...surahs];
                }
            } else if (focusArea === 'juz1-10') {
                surahPool = surahs.filter(surah => surah.juz >= 1 && surah.juz <= 10);
            } else if (focusArea === 'juz11-20') {
                surahPool = surahs.filter(surah => surah.juz >= 11 && surah.juz <= 20);
            } else if (focusArea === 'juz21-30') {
                surahPool = surahs.filter(surah => surah.juz >= 21 && surah.juz <= 30);
            }
            
            // Shuffle the surah pool
            shuffleArray(surahPool);
            
            // Generate questions
            const questions = [];
            for (let i = 0; i < questionCount && i < surahPool.length; i++) {
                const surah = surahPool[i];
                
                // Generate clues based on difficulty
                const clues = generateCluesForSurah(surah, difficulty);
                
                // Generate options for multiple choice
                let options = [];
                if (gameState.settings.questionType === 'multiple-choice') {
                    options = generateOptionsForSurah(surah);
                }
                
                questions.push({
                    surah: surah,
                    clues: clues,
                    options: options,
                    usedClues: [clues], // Start with one clue
                    remainingClues: clues.slice(1),
                    answered: false,
                    correct: false
                });
            }
            
            gameState.questions = questions;
        }
        
        // Generate clues for a surah based on difficulty
        function generateCluesForSurah(surah, difficulty) {
            const clueTypeList = clueTypes[difficulty];
            const selectedClues = [];
            
            // Create a weighted selection pool
            const weightedPool = [];
            clueTypeList.forEach(clueType => {
                for (let i = 0; i < clueType.weight; i++) {
                    weightedPool.push(clueType.type);
                }
            });
            
            // Shuffle the pool
            shuffleArray(weightedPool);
            
            // Select clue types without repeating
            const selectedTypes = [];
            for (let i = 0; i < weightedPool.length && selectedTypes.length < 5; i++) {
                const type = weightedPool[i];
                if (!selectedTypes.includes(type)) {
                    selectedTypes.push(type);
                }
            }
            
            // Generate clues based on selected types
            selectedTypes.forEach(type => {
                const clue = createClueByType(surah, type);
                if (clue) {
                    selectedClues.push(clue);
                }
            });
            
            return selectedClues;
        }
        
        // Create a specific clue by type
        function createClueByType(surah, type) {
            switch (type) {
                case 'ayahCount':
                    return {
                        type: 'ayahCount',
                        text: `This Surah has ${surah.ayahs} ayahs.`
                    };
                case 'surahType':
                    return {
                        type: 'surahType',
                        text: `This is a ${surah.type} Surah.`
                    };
                case 'meaning':
                    return {
                        type: 'meaning',
                        text: `The meaning of this Surah's name is "${surah.meaning}".`
                    };
                case 'juzNumber':
                    return {
                        type: 'juzNumber',
                        text: `This Surah is found in Juz ${surah.juz}.`
                    };
                case 'position':
                    return {
                        type: 'position',
                        text: `This is Surah number ${surah.id} in the Quran.`
                    };
                case 'famousAyah':
                    // Find a sample ayah from our data if available
                    let ayahText = "No sample available";
                    
                    const surahAyahs = quranData.filter(a => a.surah === surah.id);
                    if (surahAyahs.length > 0) {
                        // Try to get the first or a random ayah
                        const randomIndex = Math.floor(Math.random() * Math.min(5, surahAyahs.length));
                        const randomAyah = surahAyahs[randomIndex];
                        ayahText = randomAyah.arabic;
                    }
                    
                    return {
                        type: 'famousAyah',
                        text: `Sample ayah from this Surah:`,
                        arabic: ayahText
                    };
                case 'theme':
                    // Simplified themes for some surahs
                    const themes = {
                        1: "Opening of the Quran, prayer for guidance",
                        2: "Guidance for humanity, stories of prophets, legal rulings",
                        3: "Faith, family of Imran, battle of Uhud",
                        4: "Women's rights, social justice, hypocrites",
                        36: "Signs of Allah's power, resurrection, judgment",
                        55: "Blessings of Allah, repeated verse asking which of the favors do you deny",
                        56: "The Day of Judgment, three categories of people",
                        67: "Allah's sovereignty over all creation",
                        78: "The Day of Judgment, paradise and hellfire",
                        112: "The pure monotheism, Allah's uniqueness",
                        113: "Seeking refuge from evil",
                        114: "Seeking refuge from the whisperer"
                        // Add more themes as needed
                    };
                    
                    return {
                        type: 'theme',
                        text: `Main theme: ${themes[surah.id] || "Guidance for believers, Allah's signs and power"}`
                    };
                case 'startsWith':
                    // This would ideally use actual data
                    const firstAyah = quranData.find(a => a.surah === surah.id && a.ayah === 1);
                    let startText = "No data available";
                    
                    if (firstAyah) {
                        // Get first few words
                        const words = firstAyah.arabic.split(' ');
                        startText = words.slice(0, Math.min(3, words.length)).join(' ') + '...';
                    }
                    
                    return {
                        type: 'startsWith',
                        text: `This Surah starts with:`,
                        arabic: startText
                    };
                case 'distinctiveWord':
                    // Simplified distinctive words/phrases for some surahs
                    const distinctiveWords = {
                        1: "الْحَمْدُ لِلَّهِ (All praise is due to Allah)",
                        2: "البقرة (The Cow)",
                        36: "يس",
                        55: "فَبِأَيِّ آلَاءِ رَبِّكُمَا تُكَذِّبَانِ (Then which of the favors of your Lord will you deny?)",
                        112: "قُلْ هُوَ اللَّهُ أَحَدٌ (Say, He is Allah, the One)"
                        // Add more as needed
                    };
                    
                    if (distinctiveWords[surah.id]) {
                        return {
                            type: 'distinctiveWord',
                            text: `This Surah contains the distinctive phrase:`,
                            arabic: distinctiveWords[surah.id]
                        };
                    }
                    
                    return {
                        type: 'distinctiveWord',
                        text: `This Surah has a unique style and vocabulary.`
                    };
                case 'historicalContext':
                    // Simplified historical contexts for some surahs
                    const contexts = {
                        1: "Revealed early in the Makkan period, it is the opening of the Quran.",
                        2: "The longest surah in the Quran, revealed in Madinah over several years.",
                        9: "One of the last surahs to be revealed, dealing with the expedition to Tabuk.",
                        96: "The first revelation to Prophet Muhammad (PBUH) in the cave of Hira.",
                        110: "One of the last surahs revealed, signaling the approaching end of the Prophet's life."
                        // Add more as needed
                    };
                    
                    return {
                        type: 'historicalContext',
                        text: contexts[surah.id] || `Revealed in ${surah.type === 'Makki' ? 'Makkah' : 'Madinah'}.`
                    };
                default:
                    return null;
            }
        }
        
        // Generate options for multiple choice question
        function generateOptionsForSurah(correctSurah) {
            // Start with the correct answer
            const options = [correctSurah];
            
            // Add 3 incorrect options
            while (options.length < 4) {
                const randomIndex = Math.floor(Math.random() * surahs.length);
                const randomSurah = surahs[randomIndex];
                
                // Check if already included
                if (!options.find(s => s.id === randomSurah.id)) {
                    options.push(randomSurah);
                }
            }
            
            // Shuffle options
            shuffleArray(options);
            
            return options;
        }
        
        // Display a question
        function displayQuestion(questionIndex) {
            if (questionIndex >= gameState.questions.length) {
                endGame();
                return;
            }
            
            const question = gameState.questions[questionIndex];
            
            // Update progress bar
            const progressPercent = (questionIndex / gameState.questions.length) * 100;
            document.getElementById('progress-bar').style.width = `${progressPercent}%`;
            
            // Clear previous question data
            document.getElementById('clues-list').innerHTML = '';
            document.getElementById('options-container').innerHTML = '';
            document.getElementById('result-feedback').style.display = 'none';
            document.getElementById('next-question-btn').style.display = 'none';
            
            // Display clues
            const cluesList = document.getElementById('clues-list');
            
            question.usedClues.forEach(clue => {
                const clueElement = document.createElement('div');
                clueElement.className = 'clue-text';
                
                if (clue.arabic) {
                    clueElement.innerHTML = `${clue.text}<div class="arabic-text">${clue.arabic}</div>`;
                } else {
                    clueElement.textContent = clue.text;
                }
                
                cluesList.appendChild(clueElement);
            });
            
            // Set up answer options based on question type
            if (gameState.settings.questionType === 'multiple-choice') {
                document.getElementById('multiple-choice-container').style.display = 'block';
                document.getElementById('type-in-container').style.display = 'none';
                
                // Add options
                const optionsContainer = document.getElementById('options-container');
                
                question.options.forEach(option => {
                    const optionBtn = document.createElement('button');
                    optionBtn.className = 'option-btn';
                    optionBtn.textContent = option.name;
                    optionBtn.dataset.surahId = option.id;
                    
                    optionBtn.addEventListener('click', function() {
                        checkAnswer(this.dataset.surahId);
                    });
                    
                    optionsContainer.appendChild(optionBtn);
                });
            } else {
                document.getElementById('multiple-choice-container').style.display = 'none';
                document.getElementById('type-in-container').style.display = 'block';
                
                // Clear input
                document.getElementById('answer-input').value = '';
                document.getElementById('answer-input').focus();
            }
        }
        
        // Check the answer (multiple choice)
        function checkAnswer(selectedSurahId) {
            const currentQuestion = gameState.questions[gameState.currentQuestion];
            const selectedId = parseInt(selectedSurahId);
            const correctId = currentQuestion.surah.id;
            
            const isCorrect = selectedId === correctId;
            
            handleAnswer(isCorrect, selectedId);
        }
        
        // Check the answer (type-in)
        function checkTypeInAnswer() {
            const currentQuestion = gameState.questions[gameState.currentQuestion];
            const inputValue = document.getElementById('answer-input').value.trim();
            
            // First check exact match
            const exactMatch = surahs.find(s => 
                s.name.toLowerCase() === inputValue.toLowerCase());
            
            if (exactMatch) {
                const isCorrect = exactMatch.id === currentQuestion.surah.id;
                handleAnswer(isCorrect, exactMatch.id);
            } else {
                // Check fuzzy match
                const fuzzyMatches = surahs.filter(s => 
                    s.name.toLowerCase().includes(inputValue.toLowerCase()) || 
                    inputValue.toLowerCase().includes(s.name.toLowerCase()));
                
                if (fuzzyMatches.length === 1) {
                    const isCorrect = fuzzyMatches.id === currentQuestion.surah.id;
                    handleAnswer(isCorrect, fuzzyMatches.id);
                } else {
                    // No match or ambiguous
                    handleAnswer(false);
                }
            }
        }
        
        // Handle the answer result
        function handleAnswer(isCorrect, selectedSurahId = null) {
            const currentQuestion = gameState.questions[gameState.currentQuestion];
            currentQuestion.answered = true;
            currentQuestion.correct = isCorrect;
            
            // Update score
            if (isCorrect) {
                const basePoints = 100;
                const difficultyMultiplier = 
                    gameState.settings.difficulty === 'easy' ? 1 :
                    gameState.settings.difficulty === 'medium' ? 1.5 : 2;
                const cluesPenalty = (currentQuestion.usedClues.length - 1) * 10;
                
                const pointsEarned = Math.max(10, Math.round((basePoints * difficultyMultiplier) - cluesPenalty));
                
                gameState.score += pointsEarned;
                gameState.correctAnswers++;
                
                document.getElementById('current-score').textContent = gameState.score;
                
                // Update surah progress
                updateSurahProgress(currentQuestion.surah.id, true);
                
                // Show feedback
                const resultFeedback = document.getElementById('result-feedback');
                resultFeedback.style.display = 'block';
                resultFeedback.style.backgroundColor = 'rgba(46, 204, 113, 0.1)';
                resultFeedback.style.borderLeft = '5px solid #2ecc71';
                
                document.getElementById('result-text').textContent = `Correct! (+${pointsEarned} points)`;
                document.getElementById('result-detail').textContent = `"${currentQuestion.surah.name}" is the right answer.`;
                
                // In multiple choice, highlight the correct option
                if (gameState.settings.questionType === 'multiple-choice') {
                    const options = document.querySelectorAll('.option-btn');
                    options.forEach(option => {
                        if (parseInt(option.dataset.surahId) === currentQuestion.surah.id) {
                            option.classList.add('correct');
                        }
                        option.disabled = true;
                    });
                }
            } else {
                gameState.incorrectAnswers++;
                
                // Update surah progress
                if (selectedSurahId) {
                    updateSurahProgress(currentQuestion.surah.id, false);
                }
                
                // Show feedback
                const resultFeedback = document.getElementById('result-feedback');
                resultFeedback.style.display = 'block';
                resultFeedback.style.backgroundColor = 'rgba(231, 76, 60, 0.1)';
                resultFeedback.style.borderLeft = '5px solid #e74c3c';
                
                document.getElementById('result-text').textContent = 'Incorrect';
                
                let detailText = `The correct answer is "${currentQuestion.surah.name}".`;
                
                if (selectedSurahId) {
                    const selectedSurah = surahs.find(s => s.id === parseInt(selectedSurahId));
                    if (selectedSurah) {
                        detailText = `You selected "${selectedSurah.name}". ` + detailText;
                    }
                }
                
                document.getElementById('result-detail').textContent = detailText;
                
                // In multiple choice, highlight the correct and incorrect options
                if (gameState.settings.questionType === 'multiple-choice') {
                    const options = document.querySelectorAll('.option-btn');
                    options.forEach(option => {
                        const optionId = parseInt(option.dataset.surahId);
                        
                        if (optionId === currentQuestion.surah.id) {
                            option.classList.add('correct');
                        } else if (selectedSurahId && optionId === parseInt(selectedSurahId)) {
                            option.classList.add('incorrect');
                        }
                        
                        option.disabled = true;
                    });
                }
                
                // Auto-show hint if enabled and there are more clues
                if (gameState.settings.autoHints && 
                    currentQuestion.remainingClues.length > 0 &&
                    gameState.hintsRemaining > 0) {
                    useHint();
                }
            }
            
            // Store result
            gameState.results.push({
                surahId: currentQuestion.surah.id,
                surahName: currentQuestion.surah.name,
                correct: isCorrect,
                hintsUsed: currentQuestion.usedClues.length - 1
            });
            
            // Show next button
            document.getElementById('next-question-btn').style.display = 'block';
        }
        
        // Use a hint
        function useHint() {
            if (gameState.hintsRemaining <= 0) return;
            
            const currentQuestion = gameState.questions[gameState.currentQuestion];
            
            // If already answered or no more clues, return
            if (currentQuestion.answered || currentQuestion.remainingClues.length === 0) return;
            
            // Use a hint
            gameState.hintsRemaining--;
            gameState.hintsUsed++;
            
            document.getElementById('hints-remaining').textContent = gameState.hintsRemaining;
            
            // Get next clue
            const nextClue = currentQuestion.remainingClues.shift();
            currentQuestion.usedClues.push(nextClue);
            
            // Add the clue to the UI
            const clueElement = document.createElement('div');
            clueElement.className = 'clue-text fade-in';
            
            if (nextClue.arabic) {
                clueElement.innerHTML = `${nextClue.text}<div class="arabic-text">${nextClue.arabic}</div>`;
            } else {
                clueElement.textContent = nextClue.text;
            }
            
            // Add a hint badge
            const hintBadge = document.createElement('span');
            hintBadge.className = 'hint-badge';
            hintBadge.textContent = 'HINT';
            
            clueElement.prepend(hintBadge);
            
            document.getElementById('clues-list').appendChild(clueElement);
        }
        
        // Move to the next question
        function nextQuestion() {
            gameState.currentQuestion++;
            
            // Update question counter
            document.getElementById('current-question').textContent = gameState.currentQuestion + 1;
            
            // Display next question
            displayQuestion(gameState.currentQuestion);
        }
        
        // End the game and show results
        function endGame() {
            // Calculate final statistics
            const totalQuestions = gameState.questions.length;
            const accuracy = totalQuestions > 0 ? Math.round((gameState.correctAnswers / totalQuestions) * 100) : 0;
            
            // Update results screen
            document.getElementById('final-score').textContent = gameState.score;
            document.getElementById('correct-answers').textContent = gameState.correctAnswers;
            document.getElementById('incorrect-answers').textContent = gameState.incorrectAnswers;
            document.getElementById('hints-used').textContent = gameState.hintsUsed;
            document.getElementById('accuracy-percentage').textContent = `${accuracy}%`;
            
            // Clear and populate question summary
            const summaryList = document.getElementById('question-summary');
            summaryList.innerHTML = '';
            
            gameState.results.forEach((result, index) => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `Question ${index + 1}: ${result.surahName} - 
                    <span style="color: ${result.correct ? '#2ecc71' : '#e74c3c'}">
                        ${result.correct ? 'Correct' : 'Incorrect'}
                    </span>
                    ${result.hintsUsed > 0 ? ` (${result.hintsUsed} hint${result.hintsUsed > 1 ? 's' : ''} used)` : ''}`;
                summaryList.appendChild(listItem);
            });
            
            // Save game result
            saveGameResult();
            
            // Show results screen
            showScreen('results-screen');
        }
        
        // Save game result to IndexedDB
        function saveGameResult() {
            const transaction = db.transaction(['gameProgress'], 'readwrite');
            const store = transaction.objectStore('gameProgress');
            
            const gameResult = {
                date: new Date(),
                score: gameState.score,
                difficulty: gameState.settings.difficulty,
                questionType: gameState.settings.questionType,
                questionCount: gameState.settings.questionCount,
                correctAnswers: gameState.correctAnswers,
                incorrectAnswers: gameState.incorrectAnswers,
                hintsUsed: gameState.hintsUsed,
                results: gameState.results
            };
            
            store.add(gameResult);
        }
        
        // Update surah progress
        function updateSurahProgress(surahId, isCorrect) {
            const transaction = db.transaction(['surahProgress'], 'readwrite');
            const store = transaction.objectStore('surahProgress');
            
            const request = store.get(surahId);
            
            request.onsuccess = function() {
                const data = request.result;
                
                if (data) {
                    // Update existing data
                    if (isCorrect) {
                        data.timesCorrect++;
                    } else {
                        data.timesIncorrect++;
                    }
                    
                    data.lastAttempted = new Date();
                    
                    // Check if mastered (5+ correct answers with >70% accuracy)
                    const totalAttempts = data.timesCorrect + data.timesIncorrect;
                    const accuracy = totalAttempts > 0 ? (data.timesCorrect / totalAttempts) * 100 : 0;
                    
                    data.mastered = data.timesCorrect >= 5 && accuracy >= 70;
                    
                    store.put(data);
                }
            };
        }
        
        // Quit the current game
        function quitGame() {
            if (confirm('Are you sure you want to quit this game? Your progress will be lost.')) {
                showScreen('welcome-screen');
            }
        }
        
        // Load Learn Mode
        function loadLearnMode() {
            const container = document.getElementById('surah-list-container');
            container.innerHTML = '';
            
            // Get surah progress data
            const transaction = db.transaction(['surahProgress'], 'readonly');
            const store = transaction.objectStore('surahProgress');
            
            store.getAll().onsuccess = function(event) {
                const progressData = event.target.result;
                
                // Create a map for easier lookup
                const progressMap = {};
                progressData.forEach(item => {
                    progressMap[item.surahId] = item;
                });
                
                // Create surah cards
                surahs.forEach(surah => {
                    const progress = progressMap[surah.id] || {
                        timesCorrect: 0,
                        timesIncorrect: 0,
                        mastered: false
                    };
                    
                    const card = createSurahCard(surah, progress);
                    container.appendChild(card);
                });
            };
        }
        
        // Create a surah card for Learn Mode
        function createSurahCard(surah, progress) {
            const card = document.createElement('div');
            card.className = 'card';
            card.style.margin = '10px 0';
            card.style.cursor = 'pointer';
            card.dataset.surahId = surah.id;
            card.dataset.juz = surah.juz || 0;
            card.dataset.type = surah.type;
            
            // Add mastered indicator if applicable
            let masteredBadge = '';
            if (progress.mastered) {
                masteredBadge = `<span style="background: #2ecc71; color: white; padding: 3px 8px; border-radius: 10px; font-size: 0.7rem; margin-left: 10px;">Mastered</span>`;
            }
            
            // Add journey indicator if applicable
            let journeyBadge = '';
            if (myJourneyData[surah.id] && myJourneyData[surah.id].inJourney) {
                journeyBadge = `<span style="background: #3498db; color: white; padding: 3px 8px; border-radius: 10px; font-size: 0.7rem; margin-left: 10px;">In Journey</span>`;
            }
            
            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3>${surah.id}. ${surah.name} ${masteredBadge} ${journeyBadge}</h3>
                        <p>${surah.meaning} -  ${surah.ayahs} Ayahs -  ${surah.type}</p>
                    </div>
                    <div class="arabic-text" style="font-size: 1.2rem;">${surah.arabicName}</div>
                </div>
                <div style="margin-top: 10px;">
                    <small>Correct: ${progress.timesCorrect} | Incorrect: ${progress.timesIncorrect}</small>
                </div>
            `;
            
            // Add click event to show surah details
            card.addEventListener('click', function() {
                showSurahDetail(surah.id);
            });
            
            return card;
        }
        
        // Filter surahs in Learn Mode by search term
        function filterSurahs() {
            const searchTerm = document.getElementById('search-surah').value.toLowerCase();
            const cards = document.querySelectorAll('#surah-list-container .card');
            
            cards.forEach(card => {
                const surahName = card.querySelector('h3').textContent.toLowerCase();
                
                if (surahName.includes(searchTerm)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }
        
        // Filter surahs in Learn Mode by juz range
        function filterSurahsByJuz(range) {
            // Update active filter button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(`juz-filter-${range}`).classList.add('active');
            
            // Filter cards
            const cards = document.querySelectorAll('#surah-list-container .card');
            
            cards.forEach(card => {
                const juz = parseInt(card.dataset.juz);
                
                if (range === 'all') {
                    card.style.display = 'block';
                } else if (range === '1-10' && juz >= 1 && juz <= 10) {
                    card.style.display = 'block';
                } else if (range === '11-20' && juz >= 11 && juz <= 20) {
                    card.style.display = 'block';
                } else if (range === '21-30' && juz >= 21 && juz <= 30) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }
        
        // Filter surahs in Learn Mode by type (Makki/Madani)
        function filterSurahsByType(type) {
            // Update active filter button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(`filter-${type.toLowerCase()}`).classList.add('active');
            
            // Filter cards
            const cards = document.querySelectorAll('#surah-list-container .card');
            
            cards.forEach(card => {
                if (card.dataset.type === type) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }
        
        // Show surah detail in modal
        function showSurahDetail(surahId) {
            const surah = surahs.find(s => s.id === parseInt(surahId));
            if (!surah) return;
            
            // Get surah progress
            const transaction = db.transaction(['surahProgress'], 'readonly');
            const store = transaction.objectStore('surahProgress');
            
            const request = store.get(surahId);
            
            request.onsuccess = function() {
                const progress = request.result || {
                    timesCorrect: 0,
                    timesIncorrect: 0,
                    mastered: false
                };
                
                // Fill modal with surah details
                document.getElementById('modal-surah-name').textContent = `${surah.id}. ${surah.name} (${surah.meaning})`;
                document.getElementById('modal-surah-arabic').textContent = surah.arabicName;
                
                // Show surah details
                let progressHtml = '';
                if (progress.timesCorrect > 0 || progress.timesIncorrect > 0) {
                    const totalAttempts = progress.timesCorrect + progress.timesIncorrect;
                    const accuracy = totalAttempts > 0 ? Math.round((progress.timesCorrect / totalAttempts) * 100) : 0;
                    
                    progressHtml = `
                        <div style="margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                            <h4>Your Progress</h4>
                            <p>Times Correct: ${progress.timesCorrect}</p>
                            <p>Times Incorrect: ${progress.timesIncorrect}</p>
                            <p>Accuracy: ${accuracy}%</p>
                            <p>Mastered: ${progress.mastered ? 'Yes' : 'No'}</p>
                        </div>
                    `;
                }
                
                let journeyHtml = '';
                if (myJourneyData[surah.id] && myJourneyData[surah.id].inJourney) {
                    const journeyData = myJourneyData[surah.id];
                    
                    journeyHtml = `
                        <div style="margin: 15px 0; padding: 10px; background: #e8f4fd; border-radius: 8px;">
                            <h4>Your Quran Journey</h4>
                            <p>Ayahs in your journey: ${journeyData.ayahsInJourney} of ${journeyData.totalAyahs}</p>
                            <p>Coverage: ${Math.round(journeyData.coverage)}%</p>
                        </div>
                    `;
                }
                
                document.getElementById('modal-surah-details').innerHTML = `
                    <div style="margin: 15px 0;">
                        <p><strong>Type:</strong> ${surah.type}</p>
                        <p><strong>Number of Ayahs:</strong> ${surah.ayahs}</p>
                        <p><strong>Juz:</strong> ${surah.juz || 'Multiple'}</p>
                    </div>
                    ${progressHtml}
                    ${journeyHtml}
                `;
                
                // Show sample ayahs if available
                const surahAyahs = quranData.filter(a => a.surah === surah.id);
                
                let ayahsHtml = '<h4>Sample Ayahs</h4>';
                
                if (surahAyahs.length > 0) {
                    // Show first ayah and a few others
                    const samplesToShow = [
                        surahAyahs, // First ayah
                    ];
                    
                    // Add a few more if available
                    if (surahAyahs.length > 1) {
                        samplesToShow.push(surahAyahs[Math.min(5, surahAyahs.length - 1)]); // Around 5th ayah
                    }
                    
                    if (surahAyahs.length > 10) {
                        samplesToShow.push(surahAyahs[Math.min(10, surahAyahs.length - 1)]); // Around 10th ayah
                    }
                    
                    samplesToShow.forEach(ayah => {
                        ayahsHtml += `
                            <div style="margin: 10px 0; padding: 10px; background: #f9f9f9; border-radius: 8px;">
                                <div class="arabic-text">${ayah.arabic}</div>
                                <div style="margin-top: 10px; direction: rtl; text-align: right; font-style: italic;">${ayah.urdu || ''}</div>
                                <div style="margin-top: 5px; font-size: 0.8rem; color: #777;">Ayah ${ayah.ayah}</div>
                            </div>
                        `;
                    });
                } else {
                    ayahsHtml += '<p>No sample ayahs available.</p>';
                }
                
                document.getElementById('modal-surah-ayahs').innerHTML = ayahsHtml;
                
                // Set up practice button
                document.getElementById('practice-this-surah-btn').dataset.surahId = surah.id;
                document.getElementById('practice-this-surah-btn').onclick = function() {
                    practiceSingleSurah(parseInt(this.dataset.surahId));
                };
                
                // Show modal
                document.getElementById('surah-detail-modal').style.display = 'flex';
            };
        }
        
        // Hide modal
        function hideModal() {
            document.getElementById('surah-detail-modal').style.display = 'none';
        }
        
        // Start a practice session with a single surah
        function practiceSingleSurah(surahId) {
            // Set up a game with only this surah
            const surah = surahs.find(s => s.id === surahId);
            if (!surah) return;
            
            // Reset game state
            gameState.currentQuestion = 0;
            gameState.score = 0;
            gameState.hintsRemaining = 3;
            gameState.hintsUsed = 0;
            gameState.correctAnswers = 0;
            gameState.incorrectAnswers = 0;
            gameState.questions = [];
            gameState.results = [];
            
            // Generate questions for this surah only
            const clues = generateCluesForSurah(surah, gameState.settings.difficulty);
            
            let options = [];
            if (gameState.settings.questionType === 'multiple-choice') {
                options = generateOptionsForSurah(surah);
            }
            
            gameState.questions.push({
                surah: surah,
                clues: clues,
                options: options,
                usedClues: [clues], // Start with one clue
                remainingClues: clues.slice(1),
                answered: false,
                correct: false
            });
            
            // Update UI
            document.getElementById('current-question').textContent = '1';
            document.getElementById('total-questions').textContent = '1';
            document.getElementById('current-score').textContent = '0';
            document.getElementById('hints-remaining').textContent = gameState.hintsRemaining;
            
            // Hide modal and show game screen
            hideModal();
            showScreen('game-screen');
            
            // Display question
            displayQuestion(0);
        }
        
        // Export progress data
        function exportProgressData() {
            const transaction = db.transaction(['userData', 'surahProgress', 'gameProgress'], 'readonly');
            const userDataStore = transaction.objectStore('userData');
            const surahProgressStore = transaction.objectStore('surahProgress');
            const gameProgressStore = transaction.objectStore('gameProgress');
            
            Promise.all([
                getStoreData(userDataStore),
                getStoreData(surahProgressStore),
                getStoreData(gameProgressStore)
            ]).then(([userData, surahProgress, gameProgress]) => {
                const exportData = {
                    userData,
                    surahProgress,
                    gameProgress,
                    exportDate: new Date()
                };
                
                // Create download link
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportData));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "surah_challenge_data.json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            });
        }
        
        // Import progress data
// Import progress data
function importProgressData() {
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.json';
    
    fileInput.onchange = function(e) {
        const file = e.target.files[0]; // Fix: Get the first file from the FileList
        if (!file) return;
        
        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                const importData = JSON.parse(e.target.result);
                
                if (!importData.userData || !importData.surahProgress || !importData.gameProgress) {
                    alert('Invalid data format');
                    return;
                }
                
                if (confirm('This will replace your current progress data. Continue?')) {
                    processImportedData(importData); // Renamed function to avoid conflict
                }
            } catch (error) {
                console.error('Error parsing import data:', error);
                alert('Error importing data: ' + error.message);
            }
        };
        
        reader.readAsText(file);
    };
    
    fileInput.click();
}

// Process the imported data from parsed JSON
function processImportedData(importData) {
    const transaction = db.transaction(['userData', 'surahProgress', 'gameProgress'], 'readwrite');
    const userDataStore = transaction.objectStore('userData');
    const surahProgressStore = transaction.objectStore('surahProgress');
    const gameProgressStore = transaction.objectStore('gameProgress');
    
    // Clear existing data
    userDataStore.clear();
    surahProgressStore.clear();
    gameProgressStore.clear();
    
    // Import userData
    importData.userData.forEach(item => {
        userDataStore.add(item);
    });
    
    // Import surahProgress
    importData.surahProgress.forEach(item => {
        surahProgressStore.add(item);
    });
    
    // Import gameProgress
    importData.gameProgress.forEach(item => {
        gameProgressStore.add(item);
    });
    
    transaction.oncomplete = function() {
        alert('Data imported successfully!');
        loadUserSettings();
        updateHomeStats();
    };
    
    transaction.onerror = function(error) {
        console.error('Error importing data:', error);
        alert('Error importing data: ' + error.target.error);
    };
}

        
        // Confirm data reset
        function confirmResetData() {
            if (confirm('Are you sure you want to reset all your progress data? This cannot be undone.')) {
                resetAllData();
            }
        }
        
        // Reset all data
        function resetAllData() {
            const transaction = db.transaction(['userData', 'surahProgress', 'gameProgress'], 'readwrite');
            const userDataStore = transaction.objectStore('userData');
            const surahProgressStore = transaction.objectStore('surahProgress');
            const gameProgressStore = transaction.objectStore('gameProgress');
            
            // Clear data
            userDataStore.clear();
            surahProgressStore.clear();
            gameProgressStore.clear();
            
            transaction.oncomplete = function() {
                alert('All data has been reset.');
                
                // Re-initialize surah progress
                initializeSurahProgress();
                
                // Reset settings to defaults
                gameState.settings = {
                    difficulty: 'medium',
                    questionType: 'multiple-choice',
                    questionCount: 10,
                    focusArea: 'all',
                    soundEffects: true,
                    autoHints: true
                };
                
                saveUserSettings();
                loadUserSettings();
                updateHomeStats();
            };
        }
        
        // Helper: Get all data from a store
        function getStoreData(store) {
            return new Promise((resolve, reject) => {
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        
        // Helper: Shuffle array in place
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
    
        // Helper function to complete the juz values for all surahs
        surahs.forEach(surah => {
            // This is a simplified approach - in reality, surahs can span multiple juzs
            if (!surah.juz) {
                if (surah.id <= 2) surah.juz = 1;
                else if (surah.id <= 4) surah.juz = 4;
                else if (surah.id <= 9) surah.juz = 10;
                else if (surah.id <= 18) surah.juz = 15;
                else if (surah.id <= 39) surah.juz = 23;
                else if (surah.id <= 78) surah.juz = 27;
                else surah.juz = 30;
            }
        });
    </script>
    </body>
</html>
